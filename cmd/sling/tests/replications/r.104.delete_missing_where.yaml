# Test delete_missing with source_where and target_where for scoped deletion
# This simulates a use case where a large table has years of history,
# but we only want to detect deletes in recent data (e.g., last 30 days)

source: MSSQL
target: POSTGRES

hooks:
  start:
    # Create source table with data spanning different date ranges
    - type: query
      connection: '{source.name}'
      query: |
        IF OBJECT_ID('dbo.delete_where_test', 'U') IS NOT NULL DROP TABLE dbo.delete_where_test;
        CREATE TABLE dbo.delete_where_test (
          id INT PRIMARY KEY,
          created_at DATETIME,
          updated_at DATETIME,
          value NVARCHAR(100)
        );
        -- "Old" data (more than 30 days ago) - IDs 1-5
        INSERT INTO dbo.delete_where_test (id, created_at, updated_at, value) VALUES
        (1, DATEADD(day, -60, GETDATE()), DATEADD(day, -55, GETDATE()), 'old1'),
        (2, DATEADD(day, -90, GETDATE()), DATEADD(day, -85, GETDATE()), 'old2'),
        (3, DATEADD(day, -120, GETDATE()), DATEADD(day, -115, GETDATE()), 'old3'),
        (4, DATEADD(day, -150, GETDATE()), DATEADD(day, -145, GETDATE()), 'old4'),
        (5, DATEADD(day, -180, GETDATE()), DATEADD(day, -175, GETDATE()), 'old5');
        -- "Recent" data (within 30 days) - IDs 6-10
        INSERT INTO dbo.delete_where_test (id, created_at, updated_at, value) VALUES
        (6, DATEADD(day, -5, GETDATE()), DATEADD(day, -3, GETDATE()), 'recent1'),
        (7, DATEADD(day, -10, GETDATE()), DATEADD(day, -8, GETDATE()), 'recent2'),
        (8, DATEADD(day, -15, GETDATE()), DATEADD(day, -12, GETDATE()), 'recent3'),
        (9, DATEADD(day, -20, GETDATE()), DATEADD(day, -18, GETDATE()), 'recent4'),
        (10, DATEADD(day, -25, GETDATE()), DATEADD(day, -22, GETDATE()), 'recent5');

    # Create second source - same as first but remove recent IDs 9 and 10
    - type: query
      connection: '{source.name}'
      query: |
        IF OBJECT_ID('dbo.delete_where_test2', 'U') IS NOT NULL DROP TABLE dbo.delete_where_test2;
        SELECT * INTO dbo.delete_where_test2 FROM dbo.delete_where_test WHERE id NOT IN (9, 10);

  end:
    - type: check
      check: execution.status.error == 0
      on_failure: break

    # Verify total row count (10 rows)
    - type: query
      connection: '{target.name}'
      query: SELECT COUNT(*) as cnt FROM public.delete_where_test
      into: total_count

    - type: check
      check: int_parse(store.total_count[0].cnt) == 10
      failure_message: "Expected 10 total rows, got {store.total_count[0].cnt}"

    # Verify only recent rows (9, 10) are soft-deleted, old rows (1-5) are NOT deleted
    - type: query
      connection: '{target.name}'
      query: |
        SELECT COUNT(*) as cnt FROM public.delete_where_test
        WHERE id IN (9, 10) AND _sling_deleted_at IS NOT NULL
      into: deleted_recent

    - type: check
      check: int_parse(store.deleted_recent[0].cnt) == 2
      failure_message: "Expected 2 soft-deleted recent rows (9,10), got {store.deleted_recent[0].cnt}"

    # Verify old rows are NOT deleted (critical test - they should be ignored by the where clause)
    - type: query
      connection: '{target.name}'
      query: |
        SELECT COUNT(*) as cnt FROM public.delete_where_test
        WHERE id IN (1, 2, 3, 4, 5) AND _sling_deleted_at IS NOT NULL
      into: deleted_old

    - type: check
      check: int_parse(store.deleted_old[0].cnt) == 0
      failure_message: "Expected 0 soft-deleted old rows (1-5), got {store.deleted_old[0].cnt}. The where clause didn't work!"

    - type: log
      message: "SUCCESS: delete_missing with where clause correctly scoped deletion to recent data only"

    # Cleanup
    - type: query
      connection: '{source.name}'
      query: |
        IF OBJECT_ID('dbo.delete_where_test', 'U') IS NOT NULL DROP TABLE dbo.delete_where_test;
        IF OBJECT_ID('dbo.delete_where_test2', 'U') IS NOT NULL DROP TABLE dbo.delete_where_test2;

    - type: query
      connection: '{target.name}'
      query: DROP TABLE IF EXISTS public.delete_where_test CASCADE;

streams:
  # First stream: full-refresh to create table with all 10 rows
  dbo.delete_where_test:
    object: public.delete_where_test
    mode: full-refresh
    primary_key: [id]
    target_options:
      column_casing: lower

  # Second stream: incremental with delete_missing scoped to recent data only
  dbo.delete_where_test2:
    object: public.delete_where_test
    mode: incremental
    primary_key: [id]
    target_options:
      column_casing: lower
      delete_missing:
        type: soft
        source_where: created_at >= DATEADD(day, -30, GETDATE())
        target_where: created_at >= NOW() - INTERVAL '30 days'
