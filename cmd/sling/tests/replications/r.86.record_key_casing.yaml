# Test for mixed-case record key references in transform expressions

source: mysql
target: local

hooks:
  start:
    # Create test table with mixed-case column names (MySQL uses backticks for identifiers)
    - type: query
      connection: '{source.name}'
      query: |
        DROP TABLE IF EXISTS mysql.test_record_key_casing;
        CREATE TABLE mysql.test_record_key_casing (
          id INTEGER,
          `DateAdded` TIMESTAMP NULL,
          `LastChanged` TIMESTAMP NULL,
          `_sling_deleted_at` TIMESTAMP NULL,
          value TEXT
        );
        INSERT INTO mysql.test_record_key_casing (id, `DateAdded`, `LastChanged`, `_sling_deleted_at`, value)
        VALUES
          (1, '2024-01-15 10:00:00', '2024-01-20 15:30:00', NULL, 'row1'),
          (2, '2024-02-10 08:00:00', '2024-02-25 12:00:00', '2024-03-01 09:00:00', NULL),
          (3, '2024-03-05 09:00:00', '2024-03-10 18:00:00', NULL, 'row3');

    - type: command
      command: mkdir -p '{env.output_dir}'

  end:
    # Check if errored, do not proceed
    - type: check
      check: execution.status.error == 0
      on_failure: break

    # Verify output parquet file exists and has data
    - type: query
      connection: duckdb
      query: "SELECT * FROM read_parquet('{env.output_dir}/output.parquet')"
      into: result

    - type: log
      message: |
        Parquet output: {store.result}

    # Verify true_changed_at column was computed correctly
    - type: check
      check: length(store.result) == 3
      success_message: "SUCCESS: All 3 rows exported successfully with mixed-case column transform"

    # Verify the computed column has correct values (should be the greatest of the three timestamps)
    - type: check
      check: store.result[0].true_changed_at != nil
      success_message: "SUCCESS: true_changed_at column was computed correctly"

    # Cleanup
    - type: query
      connection: '{source.name}'
      query: DROP TABLE IF EXISTS mysql.test_record_key_casing;

    - type: command
      command: rm -rf '{env.output_dir}'

streams:
  mysql.test_record_key_casing:
    object: "file://{output_dir}/output.parquet"
    mode: full-refresh
    target_options:
      format: parquet
    transforms:
      # IMPORTANT: Record keys are normalized to lowercase internally
      # Even though the column is named "DateAdded", use record.dateadded (lowercase)
      # This reproduces the customer's exact expression pattern with _sling_deleted_at
      - true_changed_at: >
          greatest(record.dateadded, record.lastchanged, record._sling_deleted_at)

env:
  output_dir: temp/test_parquet