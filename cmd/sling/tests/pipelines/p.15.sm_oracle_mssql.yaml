# Schema Migration Comprehensive Test: Oracle to MSSQL
# Tests: Identity (5), FKs (4), Indexes (8), Defaults (8), Nullable (3), Descriptions (3)
# Note: Oracle source uses UPPERCASE naming convention
# Streams listed in WRONG order to test FK reordering

env:
  SOURCE: oracle
  TARGET: mssql
  SCHEMA: ORACLE

steps:
  # Clean up target first (in correct order due to FKs)
  - type: query
    connection: '{env.TARGET}'
    query: |
      IF OBJECT_ID('dbo.sm_order_items', 'U') IS NOT NULL DROP TABLE dbo.sm_order_items;
      IF OBJECT_ID('dbo.sm_orders', 'U') IS NOT NULL DROP TABLE dbo.sm_orders;
      IF OBJECT_ID('dbo.sm_products', 'U') IS NOT NULL DROP TABLE dbo.sm_products;
      IF OBJECT_ID('dbo.sm_customers', 'U') IS NOT NULL DROP TABLE dbo.sm_customers;
      IF OBJECT_ID('dbo.sm_categories', 'U') IS NOT NULL DROP TABLE dbo.sm_categories;

  # Clean up source (Oracle requires explicit error handling)
  - type: query
    connection: '{env.SOURCE}'
    query: |
      BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE {env.SCHEMA}.SM_ORDER_ITEMS CASCADE CONSTRAINTS PURGE';
      EXCEPTION WHEN OTHERS THEN NULL;
      END;

  - type: query
    connection: '{env.SOURCE}'
    query: |
      BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE {env.SCHEMA}.SM_ORDERS CASCADE CONSTRAINTS PURGE';
      EXCEPTION WHEN OTHERS THEN NULL;
      END;

  - type: query
    connection: '{env.SOURCE}'
    query: |
      BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE {env.SCHEMA}.SM_PRODUCTS CASCADE CONSTRAINTS PURGE';
      EXCEPTION WHEN OTHERS THEN NULL;
      END;

  - type: query
    connection: '{env.SOURCE}'
    query: |
      BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE {env.SCHEMA}.SM_CUSTOMERS CASCADE CONSTRAINTS PURGE';
      EXCEPTION WHEN OTHERS THEN NULL;
      END;

  - type: query
    connection: '{env.SOURCE}'
    query: |
      BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE {env.SCHEMA}.SM_CATEGORIES CASCADE CONSTRAINTS PURGE';
      EXCEPTION WHEN OTHERS THEN NULL;
      END;

  # Create source tables with all schema attributes
  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE TABLE {env.SCHEMA}.SM_CATEGORIES (
        CAT_ID NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        CAT_NAME VARCHAR2(100) NOT NULL,
        CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        IS_ACTIVE NUMBER(1) DEFAULT 1
      )

  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE TABLE {env.SCHEMA}.SM_CUSTOMERS (
        CUSTOMER_ID NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        EMAIL VARCHAR2(255) NOT NULL,
        FULL_NAME VARCHAR2(200) NULL,
        PHONE VARCHAR2(50) NULL,
        CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )

  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE TABLE {env.SCHEMA}.SM_PRODUCTS (
        PRODUCT_ID NUMBER(10) GENERATED BY DEFAULT AS IDENTITY (START WITH 100) PRIMARY KEY,
        CATEGORY_ID NUMBER(10) NOT NULL,
        PRODUCT_NAME VARCHAR2(200) NOT NULL,
        PRICE NUMBER(10,2) DEFAULT 0.00,
        STOCK_QTY NUMBER(10) DEFAULT 0,
        CONSTRAINT FK_PRODUCTS_CATEGORY FOREIGN KEY (CATEGORY_ID) REFERENCES {env.SCHEMA}.SM_CATEGORIES(CAT_ID)
      )

  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE TABLE {env.SCHEMA}.SM_ORDERS (
        ORDER_ID NUMBER(10) GENERATED BY DEFAULT AS IDENTITY (START WITH 1000 INCREMENT BY 10) PRIMARY KEY,
        CUSTOMER_ID NUMBER(10) NOT NULL,
        ORDER_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        STATUS VARCHAR2(50) DEFAULT 'pending',
        CONSTRAINT FK_ORDERS_CUSTOMER FOREIGN KEY (CUSTOMER_ID) REFERENCES {env.SCHEMA}.SM_CUSTOMERS(CUSTOMER_ID)
      )

  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE TABLE {env.SCHEMA}.SM_ORDER_ITEMS (
        ITEM_ID NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        ORDER_ID NUMBER(10) NOT NULL,
        PRODUCT_ID NUMBER(10) NOT NULL,
        QUANTITY NUMBER(10) DEFAULT 1,
        CONSTRAINT FK_ITEMS_ORDER FOREIGN KEY (ORDER_ID) REFERENCES {env.SCHEMA}.SM_ORDERS(ORDER_ID),
        CONSTRAINT FK_ITEMS_PRODUCT FOREIGN KEY (PRODUCT_ID) REFERENCES {env.SCHEMA}.SM_PRODUCTS(PRODUCT_ID)
      )

  # Add indexes
  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE INDEX IDX_CATEGORIES_NAME ON {env.SCHEMA}.SM_CATEGORIES(CAT_NAME)

  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE UNIQUE INDEX IDX_CUSTOMERS_EMAIL ON {env.SCHEMA}.SM_CUSTOMERS(EMAIL)

  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE INDEX IDX_CUSTOMERS_NAME ON {env.SCHEMA}.SM_CUSTOMERS(FULL_NAME)

  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE INDEX IDX_PRODUCTS_CATEGORY ON {env.SCHEMA}.SM_PRODUCTS(CATEGORY_ID)

  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE INDEX IDX_PRODUCTS_NAME ON {env.SCHEMA}.SM_PRODUCTS(PRODUCT_NAME)

  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE INDEX IDX_ORDERS_CUSTOMER ON {env.SCHEMA}.SM_ORDERS(CUSTOMER_ID)

  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE INDEX IDX_ORDERS_DATE ON {env.SCHEMA}.SM_ORDERS(ORDER_DATE)

  - type: query
    connection: '{env.SOURCE}'
    query: |
      CREATE INDEX IDX_ITEMS_ORDER_PRODUCT ON {env.SCHEMA}.SM_ORDER_ITEMS(ORDER_ID, PRODUCT_ID)

  # Add descriptions (column and table)
  - type: query
    connection: '{env.SOURCE}'
    query: |
      COMMENT ON COLUMN {env.SCHEMA}.SM_CATEGORIES.CAT_NAME IS 'Category name for products'

  - type: query
    connection: '{env.SOURCE}'
    query: |
      COMMENT ON COLUMN {env.SCHEMA}.SM_CUSTOMERS.EMAIL IS 'Customer email address'

  - type: query
    connection: '{env.SOURCE}'
    query: |
      COMMENT ON COLUMN {env.SCHEMA}.SM_ORDERS.STATUS IS 'Order status: pending, shipped, delivered'

  - type: query
    connection: '{env.SOURCE}'
    query: |
      COMMENT ON TABLE {env.SCHEMA}.SM_CATEGORIES IS 'Product categories lookup table'

  - type: query
    connection: '{env.SOURCE}'
    query: |
      COMMENT ON TABLE {env.SCHEMA}.SM_CUSTOMERS IS 'Customer master data'

  # Insert test data
  - type: query
    connection: '{env.SOURCE}'
    query: |
      INSERT INTO {env.SCHEMA}.SM_CATEGORIES (CAT_NAME) VALUES ('Electronics')

  - type: query
    connection: '{env.SOURCE}'
    query: |
      INSERT INTO {env.SCHEMA}.SM_CATEGORIES (CAT_NAME) VALUES ('Clothing')

  - type: query
    connection: '{env.SOURCE}'
    query: |
      INSERT INTO {env.SCHEMA}.SM_CUSTOMERS (EMAIL, FULL_NAME, PHONE) VALUES ('test@example.com', 'Test User', '555-1234')

  - type: query
    connection: '{env.SOURCE}'
    query: |
      INSERT INTO {env.SCHEMA}.SM_CUSTOMERS (EMAIL, FULL_NAME, PHONE) VALUES ('user2@example.com', NULL, NULL)

  - type: query
    connection: '{env.SOURCE}'
    query: |
      INSERT INTO {env.SCHEMA}.SM_PRODUCTS (CATEGORY_ID, PRODUCT_NAME, PRICE, STOCK_QTY) VALUES (1, 'Laptop', 999.99, 10)

  - type: query
    connection: '{env.SOURCE}'
    query: |
      INSERT INTO {env.SCHEMA}.SM_PRODUCTS (CATEGORY_ID, PRODUCT_NAME, PRICE, STOCK_QTY) VALUES (2, 'T-Shirt', 29.99, 100)

  - type: query
    connection: '{env.SOURCE}'
    query: |
      INSERT INTO {env.SCHEMA}.SM_ORDERS (CUSTOMER_ID, STATUS) VALUES (1, 'shipped')

  - type: query
    connection: '{env.SOURCE}'
    query: |
      INSERT INTO {env.SCHEMA}.SM_ORDERS (CUSTOMER_ID, STATUS) VALUES (2, 'pending')

  - type: query
    connection: '{env.SOURCE}'
    query: |
      INSERT INTO {env.SCHEMA}.SM_ORDER_ITEMS (ORDER_ID, PRODUCT_ID, QUANTITY) VALUES (1000, 100, 2)

  - type: query
    connection: '{env.SOURCE}'
    query: |
      INSERT INTO {env.SCHEMA}.SM_ORDER_ITEMS (ORDER_ID, PRODUCT_ID, QUANTITY) VALUES (1010, 101, 3)

  - replication:

      source: oracle
      target: mssql

      env:
        SLING_SCHEMA_MIGRATION: all

      defaults:
        mode: full-refresh

      # Streams listed in WRONG topological order to test FK reordering
      # Correct order: sm_categories, sm_customers, sm_products, sm_orders, sm_order_items
      streams:
        ORACLE.SM_ORDER_ITEMS:
          object: dbo.sm_order_items

        ORACLE.SM_ORDERS:
          object: dbo.sm_orders

        ORACLE.SM_PRODUCTS:
          object: dbo.sm_products

        ORACLE.SM_CATEGORIES:
          object: dbo.sm_categories

        ORACLE.SM_CUSTOMERS:
          object: dbo.sm_customers
          

  # Validate FK constraints count
  - type: query
    connection: '{env.TARGET}'
    query: |
      SELECT count(*) as cnt
      FROM sys.foreign_keys fk
      WHERE OBJECT_NAME(fk.parent_object_id) LIKE 'sm_%'
    into: fk_count

  - type: log
    message: "FK constraints found: {store.fk_count[0].cnt}"

  - type: check
    check: int_parse(store.fk_count[0].cnt) >= 1
    message: "Expected at least 1 FK constraint, got {store.fk_count[0].cnt}"

  # Validate indexes count (excluding PK)
  - type: query
    connection: '{env.TARGET}'
    query: |
      SELECT count(*) as cnt
      FROM sys.indexes i
      WHERE i.is_primary_key = 0 AND i.name IS NOT NULL AND OBJECT_NAME(i.object_id) LIKE 'sm_%'
    into: idx_count

  - type: log
    message: "Indexes found (excluding PK): {store.idx_count[0].cnt}"

  - type: check
    check: int_parse(store.idx_count[0].cnt) >= 6
    message: "Expected at least 6 indexes, got {store.idx_count[0].cnt}"

  # Validate identity columns count
  - type: query
    connection: '{env.TARGET}'
    query: |
      SELECT count(*) as cnt
      FROM sys.columns WHERE is_identity = 1 AND OBJECT_NAME(object_id) LIKE 'sm_%'
    into: identity_count

  - type: log
    message: "Identity columns found: {store.identity_count[0].cnt}"

  - type: check
    check: int_parse(store.identity_count[0].cnt) >= 5
    message: "Expected at least 5 identity columns, got {store.identity_count[0].cnt}"

  # Validate column descriptions count
  - type: query
    connection: '{env.TARGET}'
    query: |
      SELECT count(*) as cnt
      FROM sys.extended_properties ep
      JOIN sys.columns c ON ep.major_id = c.object_id AND ep.minor_id = c.column_id
      JOIN sys.tables t ON c.object_id = t.object_id
      WHERE ep.name = 'MS_Description' AND t.name LIKE 'sm_%'
    into: desc_count

  - type: log
    message: "Column descriptions found: {store.desc_count[0].cnt}"

  - type: check
    check: int_parse(store.desc_count[0].cnt) >= 1
    message: "Expected at least 1 column description, got {store.desc_count[0].cnt}"

  # Validate table descriptions count
  - type: query
    connection: '{env.TARGET}'
    query: |
      SELECT count(*) as cnt
      FROM sys.extended_properties ep
      JOIN sys.tables t ON ep.major_id = t.object_id
      WHERE ep.name = 'MS_Description' AND ep.minor_id = 0 AND t.name LIKE 'sm_%'
    into: table_desc_count

  - type: log
    message: "Table descriptions found: {store.table_desc_count[0].cnt}"

  - type: check
    check: int_parse(store.table_desc_count[0].cnt) >= 1
    message: "Expected at least 1 table description, got {store.table_desc_count[0].cnt}"

  # Clean up target
  - type: query
    connection: '{env.TARGET}'
    query: |
      IF OBJECT_ID('dbo.sm_order_items', 'U') IS NOT NULL DROP TABLE dbo.sm_order_items;
      IF OBJECT_ID('dbo.sm_orders', 'U') IS NOT NULL DROP TABLE dbo.sm_orders;
      IF OBJECT_ID('dbo.sm_products', 'U') IS NOT NULL DROP TABLE dbo.sm_products;
      IF OBJECT_ID('dbo.sm_customers', 'U') IS NOT NULL DROP TABLE dbo.sm_customers;
      IF OBJECT_ID('dbo.sm_categories', 'U') IS NOT NULL DROP TABLE dbo.sm_categories;

  # Clean up source
  - type: query
    connection: '{env.SOURCE}'
    query: |
      BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE {env.SCHEMA}.SM_ORDER_ITEMS CASCADE CONSTRAINTS PURGE';
      EXCEPTION WHEN OTHERS THEN NULL;
      END;

  - type: query
    connection: '{env.SOURCE}'
    query: |
      BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE {env.SCHEMA}.SM_ORDERS CASCADE CONSTRAINTS PURGE';
      EXCEPTION WHEN OTHERS THEN NULL;
      END;

  - type: query
    connection: '{env.SOURCE}'
    query: |
      BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE {env.SCHEMA}.SM_PRODUCTS CASCADE CONSTRAINTS PURGE';
      EXCEPTION WHEN OTHERS THEN NULL;
      END;

  - type: query
    connection: '{env.SOURCE}'
    query: |
      BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE {env.SCHEMA}.SM_CUSTOMERS CASCADE CONSTRAINTS PURGE';
      EXCEPTION WHEN OTHERS THEN NULL;
      END;

  - type: query
    connection: '{env.SOURCE}'
    query: |
      BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE {env.SCHEMA}.SM_CATEGORIES CASCADE CONSTRAINTS PURGE';
      EXCEPTION WHEN OTHERS THEN NULL;
      END;

